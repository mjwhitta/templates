#!/usr/bin/env bash

function bash_multi() {
    bash_multi_cleanup() {
        unset args flag
        unset -f bash_multi_cleanup bash_multi_usage
    }

    bash_multi_usage() {
        echo "Usage: bash_multi [OPTIONS]"
        echo
        echo "TODO"
        echo
        echo "Options:"
        echo "    -f, --flag         Example flag"
        echo "    -f, --flag=FLAG    Example for storing cli arg"
        echo "    -h, --help         Display this help message"
        echo
        bash_multi_cleanup
    }

    declare -a args
    unset flag

    while [[ $# -gt 0 ]]; do
        case "$1" in
            "--") shift && args+=("$@") && break ;;
            "-f"|"--flag") flag="true" ;;
            "-f"|"--flag"*)
                case "$1" in
                    "--"*"="*)
                        arg="${1#*=}"
                        [[ -z $arg ]] && bash_multi_usage && return 1
                        ;;
                    *)
                        shift
                        [[ $# -eq 0 ]] && bash_multi_usage && return 1
                        arg="$1"
                        ;;
                esac
                flag="--flag $arg"
                ;;
            "-h"|"--help") bash_multi_usage; return 0 ;;
            *) args+=("$1") ;;
        esac
        shift
    done
    [[ -z ${args[@]} ]] || set -- "${args[@]}"

    [[ $# -eq 0 ]] && bash_multi_usage && return 2

    for arg in "$@"; do echo "$arg"; done

    bash_multi_cleanup
}

if [[ -n ${BASH_SOURCE[0]} ]]; then
    case "$0" in
        *"bash") ;;
        *) bash_multi "$@" ;;
    esac
fi
